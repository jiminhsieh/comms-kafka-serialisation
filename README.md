# Comms platform Kafka Avro serialisation

<a href="https://ovoenergy.slack.com/messages/hello_comms"><img src="https://img.shields.io/badge/chat-on_slack-40ad85.svg?style=flat&logoWidth=14&logo=data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd%2BUAAAABmJLR0QA%2FwD%2FAP%2BgvaeTAAAFd0lEQVRIibWWe2wcVxXGf%2BfO7nq98Xq7WduxSWrHtemLJmloIFXjtHmoBaUOIV5iEYQCElJFFdQg9Q8IEigUtURI5VGhCgkk0pI%2BYjsiCZEQpU0W1bQFkoamMWqEUjv2Ur%2FW3thOvN7dmTn8kS6dWccoROL8d7%2F57vnmfHPuPSPcQJw8uSHQPJj9iYruBBl11exp%2BcqZV69nr7kRweah7B4VvgGSAO404vakn7s98X8TVOXTZVCsSMUXrmdvoBxYf%2ByHSVX5kqBjlm2eTCW%2FlS7niOG8ahlo6NjR1fWrpobm9WqsdhetE6Hrx%2Ffdc9y31y%2B2f5uqHvHUciEarPrE77c8lvfyBp5btVqFtwFssfib08S7uYgW7nhkUoNVXmtVRDuevm%2FNf3L6KlTcTv87SMtM8crngG4v7%2Bnann%2BsHd870TdjJcYuZVB7FEAiNX2J0MfW%2BgpSlS8D1xYUNWOK3ysRkkD3I6dORaJ5s0VxO2C6%2Fc%2Bjd0Tzmdd83OLY3ykTBGTMu%2FI3jXF8fhs1WLnKjsde%2F%2BuxqryMK9oNshOIButXUx7FzHuoPeeFLgQs66kFBetzH08ZtSYCuUqcjMXo%2B5Okh4aCmanhrUDEyw1EG5Fw3K%2BoNvb42SJIN8oXqwvTd%2F3o3lW%2BpgsAPH7yVI1WSBKV5MT7mcWDoxd8eYYn0tTHl%2FmTixCqW0l%2B8E%2BIFeKm6lpur3JYO3vglZXrHu2cV35J8PE3Tn9GlS6UalAaFt9MueDIZBrXdTHmI0MEJuK1refulPMPfMoaJES29GjjyPMrF9XvOnvlWoJGVZ8BqktAXayeUCDkIxWdApnpEVBGRPQXauTBaGG6%2FsnTX9u0zrowHKLopUfmhM8uWCHIEr9ThiXxpQyN9wMQDlUSi8UZLQylWte1b94n4pa4%2B4D%2B5zkKfN2bQ12TBA5fW1A5iLDbCzYkGrNFKcQDEcEO5oACOQp3pVLfN4Dr5bpqDhtxfYKItvf%2Fenk4%2B0TbbeqwXURvFZW%2F%2FHMw%2F%2FNAdXH6m1PB6osY7jXIOUfltx8sevs9nIoxG6Kei6DGnam4HzjhzT3YGEs1D2UzCjW4MPtOiJnTJirDjemgowkBUFB0Z0tjsNl3tXmj7ehTh0D83aY82%2Fv5vbv90D7z7u4%2F%2FPHKOWfT7HAe1736PSvcxVTZTeVpMwsKrju2v1NUD5XBI71n8ku79vVJS1P4AXCTomwvyHTDTNDf2YJFvLAC8V%2FXffOmRSnmZO54pVbM8uGBtwoODal0%2FYHeqVdbG0MrULemxA1pFIOFi%2BOp3KFoLhNyoyVoCtizYIUAm3%2FzxPElvemHg%2B8M86%2BJSa7gsMmJkbRr5nEvBwbIm6wPC2tCFxUbX0M57Dpuz5oPXppv6cnlXw3H3GI7Isk3renkQWss6H0e1wA%2FKDRRvrEgl5gJ9gNCKFxBpCXATW12Nr2mum7jxpRd4vksPXXLrkZjF1NAM6rcbS%2FiZUuwPRMkKzZDZo5GN%2BzdmqsgeiK4uvqh2P1zQSvmwFV748vTl9qAVInou7yNbX8XaC6tKzHc5lbOs%2B%2BMmQW4DBwStNPKm9rVF19uT2zNHbFi%2FvGm6FbvuqxppLY8%2Bd1OFX1XBQhjWLo4zsVVSyemXiks2zhwwDeLVDmMsKNM0XeTlXfpQWCbF1hBZLI1URMv3rNMhjcsYyBkASS%2B97B7K9s460tWGTlmz83285FLCv6j5bP0k4Mv9IjKdpQXBX6qYjaPDjh1%2Fd9uO5F%2BqAnnqtiHmUxHuRs3d76ZcwlsEPSXwBFRkrfsOvs7L%2Be%2FHotSrD%2B6%2F1FFny2Du3u37V1w7i0U1%2FdfGnR7gBk%2FqG%2F9r2LXLfj6lu%2BMi8oO4DyQRXimId%2F6sxsR%2FDfxXB6JocnLXwAAAABJRU5ErkJggg%3D%3D" alt="chat on slack" title="#hello_comms"/></a>
[ ![CircleCI](https://circleci.com/gh/ovotech/comms-kafka-serialisation/tree/master.svg?style=svg) ](https://circleci.com/gh/ovotech/comms-kafka-serialisation/tree/master)

[![Download](https://api.bintray.com/packages/ovotech/maven/comms-kafka-serialisation/images/download.svg)](https://bintray.com/ovotech/maven/comms-kafka-serialisation/_latestVersion)

This contains various utility functions to generate Kakfa serialisers, deserialisers, producers and consumers for case classes with Avro schemas. It consists of three modules:

* comms-kafka-serialisation
* comms-kafka-cakesolutions-helpers
* comms-kafka-akka-helpers


## How to use

Add a resolver in sbt for the Maven repo on Bintray:

```
resolvers := Resolver.withDefaultResolvers(
    Seq(
      Resolver.bintrayRepo("ovotech", "maven"),
      "confluent-release" at "http://packages.confluent.io/maven/"
    )
  )
```

Then add a dependency on the library:

```
libraryDependencies += Seq("com.ovoenergy" %% "comms-kafka-serialisation" % "version",
"com.ovoenergy" %% "comms-kafka-helpers" % "version",
"com.ovoenergy" %% "comms-kafka-test-helpers" % "version"
)
```


See the Bintray badge above for the latest version.


### Serialisation 

Then in your code, for vanilla avro json (de)serialisers                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          with no dependency on a schema registry:

```
import com.ovoenergy.comms.serialisation._

val deserializer = Serialisation.avroDeserializer[MyLovelyKafkaEvent]
val result: Option[MyLovelyKafkaEvent] = deserializer.deserialize("my-topic", messageBytes)
```


Or for binary avro (de)serialisers with schema registry support:
 
 ```
 import com.ovoenergy.comms.serialisation._
 import com.ovoenergy.kafka.serialization.avro.SchemaRegistryClientSettings

 val schemaRegistrySettings = SchemaRegistryClientSettings("schemaRegistryEndpoint:666", Authentication.None, 10, 5)
 val deserializerMaybe: Either[Retry.Failed, Deserializer[Option[T]]]= Serialisation.avroBinarySchemaRegistryDeserializer[MyLovelyKafkaEvent](schemaRegistrySettings, false, "my-topic")
 // For the sake of a simple example ;)
 val deserializer: Deserializer[Option[T]] = deserializerMaybe.right.get
 val result: Option[MyLovelyKafkaEvent] = deserializer.deserialize("my-topic", messageBytes)
 ```
 
Note that this functionality is a thin wrapper around the kafka-serialization library, more information on how the schema registry works on its [readme](https://github.com/ovotech/kafka-serialization). The only
difference in functionality is that this wrapper will register the schema with the schema registry immediately on startup when the de(serialiser) is created rather than lazily, and deserialised values will be 
optional, returning Optional.None when deserialisation fails. Additionally, if the call to register the schema fails on creation of a serialiser or deserialiser this will return a Retry.Failed


### Helpers

This is a collection of classes for dealing with the kafka topics.  It enumerates all of the topics and events on offer and allows users to make type-safe producers and consumers for aiven.
  
  ```
      import com.ovoenergy.comms.helpers.{Kafka, Topic}
      import com.ovoenergy.comms.serialisation.Codecs._

      val consumer: Either[Retry.Failed, KafkaConsumer[String, Option[TriggeredV3]]] = Kafka.aiven.triggered.v3.consumer
      val producer: Either[Retry.Failed, KafkaProducer[String, TriggeredV3]] = Kafka.aiven.triggered.v3.producer
  ```
    

### Test Helpers

Currently this consists of a utility to iterate over available topics
  
  ```
      import com.ovoenergy.comms.helpers.{Kafka, Topic}
      import ArbGenerator._
      import TopicListTraverser._
      import com.ovoenergy.comms.serialisation.Codecs._
      import shapeless._
      import org.scalacheck.Shapeless._
      
      val visitor = new TopicListVisitor {
          override def apply[E: SchemaFor : Arbitrary : ToRecord : FromRecord : ClassTag](topic: Topic[E]): Unit = {
            println(topic.name)
          }
        }
      TopicListTraverser(Kafka.aiven.allTopics, visitor)
  ```


## To release a new version

You will need to be a member of the `ovotech` organisation on Bintray.

```
$ sbt release
```

will run the tests, bump the version, build all the artifacts and publish them to Bintray.

The first time you run it, you will need to configure sbt with your Bintray credentials beforehand: `$ sbt bintrayChangeCredentials`
